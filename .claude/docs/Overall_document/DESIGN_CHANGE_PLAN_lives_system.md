# 設計変更計画書: 残機（復帰可能回数）システム導入

## 更新履歴
- 2026-01-23: 初版作成
- 2026-01-23: **Phase 1-3 実装完了**

---

## Implementation Status

### Completed (Phase 1-3)

- [x] **LivesSystem型定義** (`playerTypes.ts`)
  - `Difficulty` type, `LivesSystem` interface, `LIVES_BY_DIFFICULTY` constant
  - Helper functions: `createLivesSystem()`, `decreaseLives()`, `isGameOver()`

- [x] **PlayerContext更新** (`PlayerContext.tsx`)
  - `RuntimeBattleState` に `lives` と `difficulty` を追加
  - `decreaseLives()`, `isGameOver()`, `setDifficulty()` メソッド追加

- [x] **死亡時処理** (`deathHandler.ts`)
  - 魂の残滓100%獲得（死亡時も全て転送）
  - `handlePlayerDeathWithDetails()` で転送された魂の量を返却

- [x] **DefeatScreen UI** (`DefeatScreen.tsx`)
  - 残機表示（ハートアイコン）
  - 魂獲得表示
  - ゲームオーバー状態の表示

- [x] **HP/AP永続化バグ修正**
  - `useBattleState.ts` に `InitialPlayerState` インターフェース追加
  - `useBattleOrchestrator.ts` でPlayerContextからの初期値を渡す
  - `BattleScreen.tsx` で勝利時にHP/APを保存

- [x] **熟練度永続化バグ修正**
  - `RuntimeBattleState` に `cardMasteryStore` 追加
  - 勝利時にデッキからcardTypeIdベースで熟練度を集計・保存
  - 次のバトル開始時にmasteryStoreからデッキに熟練度を適用

### Pending (Phase 4-5)

- [ ] 転移石システムの統一（現在は実装されていない機能）
- [ ] 深淵脱出ルートの実装
- [ ] ゲームオーバー画面（完全リセット処理）
- [ ] 設計書の詳細更新（残りのドキュメント）
- [ ] テスト・検証

---

## 1. 変更概要

### 1.1 目的
「探索可能回数」システムを「残機（復帰可能回数）」システムに変更し、よりシビアかつ明確なリスク管理を実現する。

### 1.2 主要変更点サマリー

| 項目 | 旧設計 | 新設計 |
|------|--------|--------|
| ゲーム進行管理 | 探索回数制限（10回） | **残機（復帰可能回数）システム** |
| 残機上限 | - | **Hard: 2 / Normal・Easy: 3** |
| 残機減少タイミング | - | **死亡時のみ** |
| 残機回復 | - | **なし** |
| 帰還成功時 | 探索回数+1 | **残機変化なし** |
| 残機0での死亡 | - | **ゲームオーバー（完全リセット）** |
| 転移石種類 | 3種類（通常70%/祝福80%/緊急60%） | **1種類に統一（100%持ち帰り）** |
| 死亡時ペナルティ | 装備・アイテム・Gold・探索分の魂ロスト | **全所有アイテム・装備ロスト + 魂の残滓100%獲得** |
| 深淵クリア | ボス撃破で自動帰還 | **ボス撃破後に脱出ルート出現** |
| ゲームオーバー後 | 部分リセット | **完全リセット（実績のみ継続）** |

---

## 2. 詳細設計

### 2.1 残機システム

#### 2.1.1 基本仕様

```typescript
interface LivesSystem {
  // 難易度別の残機上限
  maxLives: {
    easy: 3,
    normal: 3,
    hard: 2
  };

  // 現在の残機
  currentLives: number;

  // 残機減少タイミング
  decreaseOn: 'death_only';  // 死亡時のみ

  // 残機回復
  recovery: 'none';  // 回復手段なし
}
```

#### 2.1.2 残機減少条件

| 状況 | 残機変化 | 備考 |
|------|----------|------|
| 通常探索で死亡 | **-1** | Depth 1-4での死亡 |
| 深淵（Depth5）で死亡 | **-1** | ボス戦含む |
| 帰還ルートで帰還 | **変化なし** | 安全に生還 |
| 転移石で帰還 | **変化なし** | 安全に生還 |
| 深淵ボス撃破後の脱出 | **変化なし** | クリア扱い |

#### 2.1.3 ゲームオーバー条件

```
残機0の状態で死亡 → ゲームオーバー → 完全リセット
```

---

### 2.2 死亡時ペナルティ（変更）

#### 2.2.1 旧設計
```
死亡時:
- Dungeon内の装備: 全ロスト
- Dungeon内のアイテム: 全ロスト
- 獲得したGold: 全ロスト
- 獲得した魂の残滓: 全ロスト（その探索分のみ）
- 探索回数: +1
- BaseCampの保管物: 保持
```

#### 2.2.2 新設計
```
死亡時:
- 所有アイテム: **全ロスト（装備含む）**
- 所有Gold（探索中獲得分）: **全ロスト**
- 魂の残滓: **100%獲得**（死亡時でも確実に入手）
- 残機: **-1**
- BaseCampの保管物: 保持（装備・カード・Gold・魂累計）
```

#### 2.2.3 設計意図

| 項目 | 理由 |
|------|------|
| 全アイテムロスト | 死亡のリスクを明確化。持ち込み装備も失うため慎重なプレイを促す |
| 魂の残滓100%獲得 | 死亡しても成長要素が残る。残機減少との引き換えで魂は確実に得られる |
| BaseCamp保持 | 完全なリセットは残機0時のみ。死亡でも拠点リソースは安全 |

---

### 2.3 転移石システム（統一）

#### 2.3.1 旧設計
```
3種類の転移石:
- 通常転移石: 報酬70%、戦闘中使用不可
- 祝福の転移石: 報酬80%、戦闘中使用不可
- 緊急転移石: 報酬60%、戦闘中使用可
```

#### 2.3.2 新設計
```
1種類の転移石:
- 転移石（統一版）
  - 報酬: 100%（リソース全て持ち帰り）
  - 使用条件: 戦闘中使用不可、マップ画面のみ
  - 深淵（Depth5）: 使用不可（変更なし）
```

#### 2.3.3 帰還手段の差別化

| 帰還方法 | 報酬 | リスク | 特徴 |
|----------|------|--------|------|
| 帰還ルート | 100% | 戦闘あり | 追加魂獲得可能、時間かかる |
| 転移石 | 100% | なし | 即座に安全帰還、アイテム消費 |

**差別化ポイント:**
- 帰還ルート: 戦闘リスクあり、追加報酬（魂・熟練度）あり
- 転移石: 完全安全だがアイテム消費

---

### 2.4 深淵（Depth5）特別ルール（変更）

#### 2.4.1 旧設計
```
- 転移石・帰還ルート: 使用不可
- ボス撃破: 自動帰還（クリア）
- 死亡: 探索回数+1 + 全アイテムロスト
```

#### 2.4.2 新設計
```
- 転移石・帰還ルート: 使用不可（変更なし）
- ボス撃破後: **脱出ルート出現** → 安全に帰還
- 死亡: **残機-1** + 全アイテムロスト + **魂100%獲得**
```

#### 2.4.3 脱出ルート仕様

```typescript
interface EscapeRoute {
  // 出現条件
  trigger: 'boss_defeated';  // ボス撃破後に出現

  // ルート内容
  encounters: 'none';  // 戦闘なし

  // 報酬
  rewardMultiplier: 1.0;  // 100%持ち帰り

  // UI表現
  display: '深淵からの脱出口が開いた...'
}
```

---

### 2.5 ゲームオーバー時の処理（変更）

#### 2.5.1 旧設計
```
探索回数超過時:
- 部分リセット
- 一部の進行状況は保持
```

#### 2.5.2 新設計
```
残機0で死亡時:
- 完全リセット
  - Gold: 初期値（500G）に戻る
  - 装備: 初期装備のみ
  - 魂の残滓（累計）: 0に戻る
  - Sanctuary解放状況: リセット
  - カードデッキ: 初期デッキに戻る
  - 難易度設定: 維持
  - 図鑑記録: リセット
  - 既知イベント情報: リセット

- 継続されるもの
  - **実績解除状況のみ**
```

---

### 2.6 生還時の処理（変更）

#### 2.6.1 旧設計
```
生還時（帰還ルート/転移石）:
- 全アイテム持ち帰り（転移石は報酬倍率適用）
- 魂の残滓: 帰還方法に応じた倍率で累計に加算
- 探索回数: +1
```

#### 2.6.2 新設計
```
生還時（帰還ルート/転移石）:
- 全アイテム100%持ち帰り（統一）
- 魂の残滓: 100%累計に加算
- 残機: **変化なし**
```

---

## 3. 影響を受ける設計書と変更箇所

### 3.1 game_design_master.md

| セクション | 変更内容 |
|------------|----------|
| 2.1 コアループ | 探索回数制限 → 残機システム |
| 2.2 リスク・リターン | 死亡ペナルティ更新 |
| 2.3 探索回数制限システム | 残機システムに全面書き換え |
| 3.2 ゲーム全体の流れ | フェーズ説明を残機ベースに |
| 3.3 エンディング条件 | 失敗条件を残機ベースに |
| 5.3 探索回数制限のバランス | 削除または残機バランスに |

### 3.2 return_system_design.md

| セクション | 変更内容 |
|------------|----------|
| 1.2 生還と死亡の違い | 残機・魂獲得ルール更新 |
| 3. 転移石システム | 1種類に統一、報酬100% |
| 5. 深淵特別ルール | 脱出ルート追加 |
| 6. 報酬計算 | 転移石報酬倍率削除 |
| 7. 探索回数制限との関係 | 残機システムとの関係に |

### 3.3 dungeon_exploration_ui_design_v2.1.md

| セクション | 変更内容 |
|------------|----------|
| 1.3 探索回数システム | 残機システムに変更 |
| 4.1 画面構成 | 残機表示に変更 |
| 5. 帰還システムUI | 転移石統一、報酬表示更新 |
| 6.2 動的変化エフェクト | 残機警告に変更 |

### 3.4 sanctuary_design.md

| セクション | 変更内容 |
|------------|----------|
| 2.1 魂の残滓 | 死亡時100%獲得ルール |
| 2.2 スキルツリー | 探索回数拡張スキル削除 |
| 5.3 魂の残滓システム | 死亡時処理変更 |
| 6. PlayerContext統合 | 残機システム連携 |
| 8.1 バランス調整 | 死亡時魂獲得を考慮 |

### 3.5 inventory_design.md

| セクション | 変更内容 |
|------------|----------|
| 6.3 死亡時のロストルール | 全所有アイテムロストに更新 |
| 6.4 生還時のルール | 100%統一に更新 |

### 3.6 guild_design.md（軽微）

| セクション | 変更内容 |
|------------|----------|
| 探索回数参照箇所 | 残機参照に変更（あれば） |

---

## 4. データ構造の変更

### 4.1 新規: LivesSystem

```typescript
// src/types/GameTypes.ts

export type Difficulty = 'easy' | 'normal' | 'hard';

export interface LivesSystem {
  maxLives: number;  // 難易度により2または3
  currentLives: number;
}

export const LIVES_BY_DIFFICULTY: Record<Difficulty, number> = {
  easy: 3,
  normal: 3,
  hard: 2,
};
```

### 4.2 変更: PlayerContext

```typescript
// 旧
interface Player {
  explorationLimit: {
    max: number;
    current: number;
  };
}

// 新
interface Player {
  lives: {
    max: number;      // 難易度による上限 (2 or 3)
    current: number;  // 現在の残機
  };
  difficulty: Difficulty;
}
```

### 4.3 変更: TeleportStone

```typescript
// 旧
interface TeleportStone {
  type: 'normal' | 'blessed' | 'emergency';
  rewardMultiplier: number;  // 0.7 / 0.8 / 0.6
  canUseInBattle: boolean;
}

// 新
interface TeleportStone {
  type: 'standard';  // 統一
  rewardMultiplier: 1.0;  // 100%固定
  canUseInBattle: false;  // 戦闘中使用不可
}
```

### 4.4 変更: SanctuaryProgress

```typescript
// 旧
interface SanctuaryProgress {
  currentRunSouls: number;
  totalSouls: number;
  explorationLimitBonus: number;  // 削除
}

// 新
interface SanctuaryProgress {
  currentRunSouls: number;
  totalSouls: number;
  // explorationLimitBonus は削除（残機拡張スキルなし）
}
```

### 4.5 変更: 死亡時処理

```typescript
// 旧
function handleDeath(player: Player): void {
  // 探索分の魂リセット
  currentRunSouls = 0;
  // 探索回数+1
  explorationLimit.current++;
}

// 新
function handleDeath(player: Player): void {
  // 魂を100%獲得
  player.totalSouls += currentRunSouls;
  currentRunSouls = 0;

  // 残機-1
  player.lives.current--;

  // 全所有アイテムロスト
  player.inventory = getEmptyInventory();
  player.equipment = {};
  player.gold = 0;  // 探索中のGoldのみ

  // 残機0チェック
  if (player.lives.current <= 0) {
    triggerGameOver(player);
  }
}
```

---

## 5. UI変更

### 5.1 ヘッダー表示

```
旧: Exploration: 7/10
新: Lives: ❤️❤️❤️ (残り3) または ❤️❤️ (残り2)
```

### 5.2 帰還メニュー

```
旧:
┌─────────────────────────────────────┐
│  1. 転移石（通常）  報酬: 70%        │
│  2. 転移石（祝福）  報酬: 80%        │
│  3. 転移石（緊急）  報酬: 60%        │
│  4. 帰還ルート      報酬: 100%       │
└─────────────────────────────────────┘

新:
┌─────────────────────────────────────┐
│  1. 転移石          報酬: 100%       │
│     所持: 2個       即座に帰還       │
│                                     │
│  2. 帰還ルート      報酬: 100%       │
│     戦闘あり        追加魂獲得可能   │
└─────────────────────────────────────┘
```

### 5.3 死亡時表示

```
旧:
「探索失敗... 全てを失った」
探索回数: 7 → 8

新:
「探索失敗... 全てを失った」
「しかし、魂の残滓は手に入れた...」
魂の残滓: +85 → 累計 650
残機: ❤️❤️❤️ → ❤️❤️
```

### 5.4 ゲームオーバー表示

```
┌─────────────────────────────────────┐
│         GAME OVER                   │
│                                     │
│  残機が尽きた...                     │
│                                     │
│  最終到達深度: Depth 4              │
│  累計獲得魂: 1,250                  │
│  撃破した敵: 87体                   │
│                                     │
│  [解除された実績は保持されます]       │
│                                     │
│  [最初からやり直す]                  │
└─────────────────────────────────────┘
```

---

## 6. 実装順序

### Phase 1: データ構造変更（Day 1）
1. LivesSystem型定義
2. PlayerContext更新（explorationLimit → lives）
3. TeleportStone型統一
4. SanctuaryProgress更新

### Phase 2: ロジック変更（Day 2）
1. 死亡時処理（魂100%獲得 + 残機減少）
2. 帰還時処理（残機変化なし）
3. ゲームオーバー処理（完全リセット）
4. 深淵脱出ルート処理

### Phase 3: UI変更（Day 3）
1. ヘッダー残機表示
2. 帰還メニュー更新
3. 死亡時演出
4. ゲームオーバー画面

### Phase 4: 設計書更新（Day 4）
1. game_design_master.md
2. return_system_design.md
3. dungeon_exploration_ui_design_v2.1.md
4. sanctuary_design.md
5. inventory_design.md

### Phase 5: テスト・検証（Day 5）
1. 死亡→残機減少フロー
2. 帰還→残機維持フロー
3. ゲームオーバー→完全リセット
4. 深淵脱出ルート
5. 難易度別残機上限

---

## 7. 整合性チェックリスト

### 7.1 システム間整合性

- [ ] 残機システムと死亡ペナルティの整合性
- [ ] 転移石統一と帰還ルートの差別化
- [ ] 深淵特別ルールと脱出ルートの整合性
- [ ] Sanctuary魂獲得と死亡時処理の整合性
- [ ] ゲームオーバーリセットと継続データの整合性

### 7.2 UI整合性

- [ ] ヘッダー表示と残機システムの整合性
- [ ] 帰還メニューと転移石統一の整合性
- [ ] 死亡時演出と魂100%獲得の表現
- [ ] ゲームオーバー画面と完全リセットの説明

### 7.3 バランス整合性

- [ ] 難易度別残機上限の妥当性
- [ ] 死亡時全ロスト＋魂獲得のバランス
- [ ] 転移石100%持ち帰りと帰還ルートの価値バランス

---

## 8. 変更による影響分析

### 8.1 ゲーム体験への影響

| 側面 | 旧 | 新 | 影響 |
|------|----|----|------|
| 緊張感 | 探索回数消費で中程度 | 残機減少で高い | **UP** |
| 救済要素 | 探索回数拡張スキル | 魂100%獲得 | 形態変化 |
| 戦略性 | 探索回数管理 | 残機温存 + 装備リスク | **UP** |
| リプレイ性 | 部分リセット | 完全リセット | **DOWN**（意図的） |

### 8.2 削除される要素

1. **探索回数システム** → 残機に置換
2. **探索回数拡張スキル** → 削除
3. **転移石バリエーション** → 統一

### 8.3 追加される要素

1. **残機システム**
2. **難易度別残機上限**
3. **深淵脱出ルート**
4. **死亡時魂100%獲得**

---

## 9. 承認事項

本計画に基づき、以下の設計書を更新します:

1. game_design_master.md
2. return_system_design.md
3. dungeon_exploration_ui_design_v2.1.md
4. sanctuary_design.md
5. inventory_design.md

**承認後、各設計書の更新を開始します。**
