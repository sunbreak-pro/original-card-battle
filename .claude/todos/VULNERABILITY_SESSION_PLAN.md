# Vulnerability Remediation & Remaining Tasks — Session Plan

> 77 vulnerabilities (from `vulnerability-remediation-guide.md`) + 11 remaining tasks (from `MASTER_IMPLEMENTATION_PLAN.md`) + 4 user-reported bugs unified into 13 executable sessions.
> Created: 2026-02-01

---

## Overview

| Metric | Count |
|--------|-------|
| Total vulnerabilities | 77 |
| MASTER_PLAN remaining tasks | 11 (U1-U7, F1-F2, Q1-Q2) |
| Sessions | 13 |
| Immutable files (skip) | V-CARD-12, V-CARD-13 (deck.ts, deckReducter.ts) |

### Priority Principles

1. **Critical bugs / design violations first** — Tier 0 & 1 form the foundation
2. **Features and UI polish last** — Tier 3, UI, new features deferred to Session 12
3. **Batch similar patterns** — stale closures, dead code, naming typos grouped together

### Dependency Graph

```
Session 1 (State Foundation)
    ├── Session 2 (Save & Inventory) — depends on Session 1
    │       └── Session 13 (New Bug Fixes) — depends on Session 2
    ├── Session 3 (Battle Stale Closures) — depends on Session 1
    │       └── Session 4 (Battle Logic) — depends on Session 3
    │               └── Session 5 (DoT & Stack Consistency) — depends on Session 4
    │                       └── Session 6 (Class & Card Mechanics) — depends on Session 5
    │                               └── Session 7 (Economy & Dungeon) — independent of battle sessions
    └── Session 8-9-10-11 (Cleanup / Refactoring) — independent, any order after Session 6
            └── Session 12 (UI & Features) — last
```

---

## Session 1: State Foundation — Context Integrity (Tier 0)

**Prerequisites:** None (first session)
**Goal:** Establish single-source-of-truth for state management across all contexts.

| ID | File | Issue | Fix |
|----|------|-------|-----|
| V-CS01 | `PlayerContext.tsx:531-667` | Dual resource state (PlayerContext duplicates ResourceContext gold/magicStones) | Delegate all resource ops to ResourceContext; remove duplicates from PlayerContext |
| V-CS04 / V-PLR-01 | `PlayerContext.tsx:772` | Player ID regenerates on every recomputation (`player_${Date.now()}` in useMemo) | Generate ID once with `useRef`/`useState` initializer; persist through save |
| V-CS02 | `ResourceContext.tsx:117-145` | useGold race condition — balance check outside functional updater | Move balance check inside `setResources` functional updater |
| V-CS03 | `ResourceContext.tsx:224-241` | useExplorationPoint returns stale success value | Return value from within functional updater via ref or callback |
| V-CS11 / V-INV-01 | `InventoryContext.tsx:48` | Stale playerData closure in rapid operations | Convert all inventory mutations to `setPlayerData(prev => ...)` |

**Vulnerabilities fixed:** 5
**Verification:**
- Save → reload → verify gold, stones, inventory unchanged
- Buy item rapidly 3x → gold decremented exactly 3× price
- Navigate between screens 5x → same player ID throughout

---

## Session 2: Inventory & Save Critical (Tier 0 + Save)

**Prerequisites:** Session 1 (state must be correct before saving)

| ID | File | Issue | Fix |
|----|------|-------|-----|
| V-INV-02 | `InventoryContext.tsx:211-216` | equipItem only removes from storage, not equipmentInventory | Add removal branch for equipmentInventory source |
| V-CS06 | `saveManager.ts:193-232` | Save misses `inventory` and `equipmentInventory` | Add to SaveData type and save/load logic |
| V-EC-06 | `saveTypes.ts:29-32` | Save excludes exploration resources | Add exploration resources to SaveData |
| V-CS07 | `saveManager.ts:172-186` | `migrate()` is a stub — format changes corrupt saves | Implement version-based migration chain |

**Vulnerabilities fixed:** 4 (+ V-INV-02 from Tier 0 = 5 total including Tier 0 item)
**Verification:**
- Full save/load cycle with items in all storage locations
- Equip item from equipmentInventory → no duplication
- Save format version bump → old save migrates correctly

---

## Session 3: Battle Core — Stale Closure Sweep (Tier 1 + Tier 2)

**Prerequisites:** Session 1 (functional updater patterns established)

| ID | File | Issue | Fix |
|----|------|-------|-----|
| V-CARD-04 | `useCardExecution.ts:468-483` | Heal uses stale HP from closure | `setPlayerHp(prev => Math.min(prev + healAmount, maxHp))` |
| V-CARD-07 | `useCardExecution.ts:410-421` | Auto-bleed reads stale enemy buffs | Accumulate all buff changes into single update |
| V-ORCH-01 | `useBattleOrchestrator.ts:550-608` | executeNextPhaseRef updates via useEffect (gap) | Assign ref immediately after function definition |
| V-ORCH-02 | `useBattleOrchestrator.ts:562` | Phase queue expansion uses stale enemies array | Read enemies from ref or functional updater |
| V-ORCH-03 | `useBattleOrchestrator.ts:648` | handleEndPhase reads stale currentPhaseIndex | Use ref for currentPhaseIndex |
| V-ORCH-04 | `useBattlePhase.ts:82-111` | generatePhaseQueue double-call uses same random state | Guard against double invocation or use seeded PRNG |

**Vulnerabilities fixed:** 6
**Verification:**
- Play 5 battles → no stale HP after heal
- Multi-enemy battle → phase queue correct after enemy death
- No console errors during rapid card plays

---

## Session 4: Battle Core — Logic Fixes (Tier 1)

**Prerequisites:** Session 3 (stale closures resolved)

| ID | File | Issue | Fix |
|----|------|-------|-----|
| V-DMG-04 | `buffCalculation.ts:135-137` | canAct() only checks stun; freeze/stagger ignored | `DISABLING_DEBUFFS.some(d => map.has(d))` |
| V-CARD-02 | `useCardExecution.ts:429-461` | Guard double application (shieldGain + guardAmount) | Single source of truth for guard; remove duplicate path |
| V-CARD-09 | `useDeckManage.ts` | Deck management hardcodes SWORDSMAN_CARDS_ARRAY (dead code) | Deleted file — unused hook, deck managed elsewhere |
| V-CLASS-03 | `elementalSystem.ts:170-218` | Resonance effects (burn/freeze/stun) never called in battle | Call `getResonanceEffects()` in useCardExecution after damage calc |

**Vulnerabilities fixed:** 4
**Verification:**
- Apply freeze to enemy → enemy skips turn
- Play defense card → guard = ONE of shieldGain or guardAmount, not both
- Start battle as Mage → deck contains Mage cards
- Chain 3 fire cards as Mage → burn debuff applied

---

## Session 5: Battle Consistency — DoT & Stack System (Tier 2)

**Prerequisites:** Session 4 (battle core stable)

| ID | File | Issue | Fix |
|----|------|-------|-----|
| V-DMG-06 | `bleedDamage.ts` | Bleed damage ignores stacks | Multiply `value * stacks` |
| V-DMG-10 | `buffCalculation.ts:120-124` | Burn/Poison DoT ignores stacks | Multiply `value * stacks` |
| V-DMG-01 | `playerPhaseExecution.ts:71-74` | Healing uses pre-duration-decrease buffs (inconsistent with DoT) | Choose and enforce universal timing rule |
| V-CARD-01 / V-CLASS-01 | `useCardExecution.ts:320` | Sword energy bonus uses pre-consumption value | Calculate bonus before energy consumption |
| V-DMG-03 | `damageCalculation.ts:52-57` | Guard bleed-through condition counter-intuitive | Review and fix guard absorption logic |
| V-DMG-05 | `buffCalculation.ts:162-167` | immunityBuff return semantics inverted (true=allow) | Fix return value or rename for clarity |

**Vulnerabilities fixed:** 6
**Verification:**
- Apply bleed 3x → bleed damage = `floor(maxHp * rate) * 3`
- Apply burn 2x → DoT damage doubled
- Healing timing consistent between player and enemy phases

---

## Session 6: Class & Card Mechanics (Tier 2)

**Prerequisites:** Session 5 (DoT/stack system consistent)

| ID | File | Issue | Fix |
|----|------|-------|-----|
| V-CLASS-13 | `elementalSystem.ts:48-77` | Dual-element card inconsistent find vs includes | Standardize to one approach |
| V-CLASS-02 | `elementalSystem.ts:47-57` | Non-magic cards reset resonance chain completely | Design decision: partial decay vs full reset |
| V-CLASS-04 | `classAbilitySystem.ts:22-30` | critBonus/penetration fields never used in damage pipeline | Wire into damage calc or remove dead code |
| V-CARD-03 | `useCardExecution.ts:446-461` | Hardcoded card IDs (sw_037/039/040) for sword energy guard | Add `convertEnergyToGuard` card property |
| V-CARD-17 | `cardPlayLogic.ts` | requiresSummon not enforced in canPlayCard | Add check in canPlayCard |
| V-CARD-18 | `getMasteryBonus` | Returns decimal; callers must add 1.0 (fragile API) | Return `1.0 + bonus` or document clearly |

**Vulnerabilities fixed:** 6
**Verification:**
- Dual-element cards chain correctly
- Cards with `requiresSummon` cannot be played without active summon
- Sword energy guard cards use property-based check, not ID-based

---

## Session 7: Economy & Dungeon Edge Cases (Tier 2)

**Prerequisites:** Session 2 (save system correct). Independent of battle sessions.
**Status:** ✅ Complete — 3 fixed, 1 previously implemented, 3 skipped (acceptable risk)

| ID | File | Issue | Fix | Status |
|----|------|-------|-----|--------|
| V-EC-01 | `shopLogic.ts:83-124` | Magic stone exchange overpays without warning | `calculateStonesToConsume` has early return; overpay minimized via small→large order | ⏭️ Skipped (functional) |
| V-EC-08 | `BuyTab.tsx` | Daily rotation seed not persisted (Date.now() recalculated) | `shopRotationDay` added to `PlayerProgression`/`ProgressionSaveData`; saved/loaded via PlayerContext; migration default in `saveManager.ts` | ✅ Fixed |
| V-EC-12 | `ResourceContext.tsx:267-309` | Transfer multiplier floors per-tier | Per-tier Math.floor is functional; total→reconvert is ideal but low impact | ⏭️ Skipped (functional) |
| V-DNG-03 | `nodeEventLogic.ts:194` | Trap damage uses negative hpRestore | Functionally correct; comment explains intent | ⏭️ Skipped (low risk) |
| V-ENM-07 | `enemyActionExecution.ts:65-77` | Fallback action hardcoded 5 damage | `getFallbackAction` now uses 50% of average baseDamage from enemy's aiPatterns (min 3) | ✅ Fixed |
| V-ENM-01 | `enemyAI.ts:23` | _remainingEnergy ignored in AI selection | Already uses `enemyEnergy` param in `executeEnemyActions` | ⏭️ Already OK |
| V-INV-07 | `equipmentStats.ts` + battle hooks | Equipment durability never decremented in battle | Already implemented: `onApDamage` callback wired from PlayerContext → BattleScreen → useBattleOrchestrator → executeCharacterManage | ✅ Already implemented |

**Additional fix (critical bug):**
| — | `UpgradeTab.tsx` + `ResourceContext.tsx` | Blacksmith upgrades consume gold but NOT magic stones | Added `spendBaseCampMagicStones()` to ResourceContext; called in both `handleLevelUpgrade` and `handleQualityUpgrade` | ✅ Fixed |

**Vulnerabilities fixed:** 3 new + 1 critical bug fix + 1 already implemented
**Verification:**
- Blacksmith upgrade → gold AND magic stones consumed
- Shop rotation persists across save/load
- Deep-layer enemy fallback attack deals scaled damage
- Equipment durability decreases when AP absorbs damage

---

## Session 8: Dead Code & Duplicate Sweep (Tier 3 — batch)

**Prerequisites:** Session 6 complete (so removed code is truly unused)

| ID | File | Issue | Action |
|----|------|-------|--------|
| V-CARD-05/10 | `card.ts`, `cardPlayLogic.ts` | Duplicate `calculateCardEffect` | Delete one; consolidate callers |
| V-DMG-09 | `buffLogic.ts:94-110` | Deprecated `decreaseBuffDebuffDuration` coexists with new | Delete deprecated version |
| V-ORCH-06 | `useBattleOrchestrator.ts:405` | useEnemyAI return value discarded | Remove assignment or use return value |
| V-ORCH-07 | `useBattleOrchestrator.ts:800-882` | Legacy deprecated aliases in return object | Remove aliases; update consumers |
| V-CS12 | `useBattleState.ts:460-494` | Battle state dual API surface (35 lines duplication) | Consolidate to single API |
| V-INV-03 | `InventoryContext.tsx:441-519` | Duplicate move directions | Merge equivalent directions |
| V-CLASS-08 | `useClassAbility.ts` etc. | Three identical hook wrappers (~160 lines) | Extract shared wrapper |
| V-ENM-06 | `enemyPhaseExecution.ts`, `useEnemyAI.ts` | Duplicate guard-only check | Extract shared predicate |
| V-CLASS-10 | `classAbilityUtils.ts:15`, `characterConstants.ts:30` | SWORD_ENERGY_MAX defined twice | Single canonical export |
| V-CLASS-11 | `classAbilitySystem.ts:35`, `characterConstants.ts:37` | DEFAULT_DAMAGE_MODIFIER defined twice | Single canonical export |

**Vulnerabilities fixed:** 11 (including V-CARD-11: unused `damageBonus: 0` return)
**Verification:**
- `npm run build` succeeds
- Full game flow works (select → camp → dungeon → battle → camp)

---

## Session 9: Naming & File Organization (Tier 3 — batch)

**Prerequisites:** Session 8 (dead code removed first to minimize rename conflicts)

| ID | File | Issue | Action |
|----|------|-------|--------|
| V-CARD-15 | `SwordmanCards.ts` | Typo: "Swordman" → "Swordsman" | Rename file + update all imports |
| V-PLR-07 | `tittle.ts` | Typo: "tittle" → "title" | Rename file + update all imports |
| V-DNG-06 | `deptManager.ts` | Typo: "dept" → "depth" | Rename file + update all imports |
| V-DNG-04 | `src/ui/dungeonHtml/DungeonRunContext` | DungeonRunContext in wrong directory | Move to `src/contexts/` |
| V-CS08 / V-EC-11 | `ResourceContext.tsx:67-81` | Hardcoded test gold/stones in production init | Extract to separate config; use 0 defaults in prod |
| V-INV-05 | `TestItemsData.ts` | Test items loaded in production build (273 lines) | Exclude from production or gate behind env flag |

**Vulnerabilities fixed:** 6
**Verification:**
- `npm run build` succeeds
- All imports resolve correctly
- No test data in production build

---

## Session 10: Hardcoded → Data-Driven Conversion (Tier 3)

**Prerequisites:** Session 6 (class mechanics finalized before changing data structures)

| ID | File | Issue | Action |
|----|------|-------|--------|
| V-DMG-07 | `buffCalculation.ts:9-62` | Attack/defense buffs are hardcoded if-chains | Data-driven buff effect map |
| V-CARD-08 | `card.ts:58-68` | calculateCardEffect handles 3 of 6 categories | Extend to all card categories |
| V-DMG-08 | `damageCalculation.ts` | No damage type system (single pipeline) | Design and implement damage type routing |
| V-ENM-03 | `enemyActionExecution.ts` | Enemy actions always `element: ["physics"]` | Allow variable element per action definition |

**Vulnerabilities fixed:** 4
**Verification:**
- Buff effects apply correctly via data-driven map
- All card categories process through unified pipeline
- Enemy elemental attacks work correctly

---

## Session 11: Large File Refactoring (Tier 3)

**Prerequisites:** Sessions 1-6 (all logic fixes complete before structural refactoring)

| ID | File | Issue | Action |
|----|------|-------|--------|
| V-CS05 | `PlayerContext.tsx` (939 lines) | SRP violation — too many responsibilities | Extract sub-hooks: `usePlayerBattle`, `usePlayerProgression`, `usePlayerDeck` |
| V-ORCH-05 | `useBattleOrchestrator.ts` (882 lines) | SRP violation — too many phases in one hook | Extract: `usePhaseQueue`, `usePhaseExecution`, `useBattleFlow` |
| Q2 | `FacilityHeader.tsx:23` | Unused `variant` prop | Remove prop; simplify component |

**Vulnerabilities fixed:** 3 + 1 MASTER_PLAN task (Q2)
**Verification:**
- `npm run build` succeeds
- Battle flow unchanged (behavioral regression test)
- Camp facilities render correctly

---

## Session 12: UI Polish & New Features (MASTER_PLAN remaining)

**Prerequisites:** All previous sessions (codebase stable and clean)

### UI Polish (U1-U7)

| ID | Task | Key Files |
|----|------|-----------|
| U1 | Per-Enemy Width | `characterTypes.ts`, `enemyDepth1-5.ts`, `EnemyFrame.tsx`, `battle-enemy.css` |
| U2 | Battle Field Layout | `BattleScreen.tsx`, `PlayerFrame.tsx`, `battle-layout.css` |
| U3 | Victory/Defeat Modal Overlay | `BattleScreen.tsx`, `VictoryScreen.css`, `DefeatScreen.css` |
| U4 | Escape Animation | `BattleScreen.tsx`, `battle-layout.css` |
| U5 | Card Play Animation | `useCardAnimation.tsx`, `BattleScreen.tsx`, `uiConstants.ts` |
| U6 | Sanctuary UI Fixes | `Sanctuary.css`, `NodeDetailPanel.tsx` |
| U7 | Map Node Player Status | `NodeMap.tsx`, `NodeMap.css` |

### New Features (F1-F2)

| ID | Task | Details |
|----|------|---------|
| F1 | AoE Card Support | Card type flag, damage loop over all enemies, UI feedback |
| F2 | Teleport Stone Item | Instant dungeon return item |

### Code Quality (Q1)

| ID | Task | Details |
|----|------|---------|
| Q1 | EnemyFrame emoji → SVG | Replace emoji action icons with SVG |

### Remaining Tier 3 Vulnerabilities

| ID | Summary |
|----|---------|
| V-DNG-01 | Map generation uses unseeded Math.random() |
| V-DNG-02 | Floor advancement doesn't escalate difficulty |
| V-DNG-05 | Node connections can create unreachable nodes |
| V-DNG-07 | encounterCount inflated by non-battle nodes |
| V-DMG-02 | Curse + OverCurse stacking reduces heal to 10% |
| V-CARD-14 | Card id equals cardTypeId — duplicates share same ID |
| V-CLASS-05 | combineDamageModifiers multiplies (not additive) |
| V-CLASS-06 | Summoner bondLevel starts at 1 (immediate 5% bonus) |
| V-CLASS-07 | 8 empty resonance effect entries |
| V-CLASS-09 / V-PLR-03 | SummonSystem mostly stub |
| V-CLASS-12 | Sword energy _card parameter unused |
| V-PLR-06 | Title functions disconnected from gameplay |
| V-DMG-11 | Weakness/prostoration defined but unused |
| V-INV-04 | Capacity tracked manually instead of items.length |
| V-INV-06 | No item stacking for consumables |
| V-CS09 | Quest expiry uses Date object (won't survive JSON) |
| V-EC-02 | Equipment packs skip uncommon rarity |
| V-EC-03 | Quality upgrade consumes resources on failure |
| V-EC-04 | Sanctuary effects recalculated every call (no cache) |
| V-EC-05 | Dismantle returns very low value for common items |
| V-EC-07 | Common/uncommon share identical upgrade costs |
| V-EC-09 | No endgame gold sink |
| V-EC-10 | explorationLimitBonus not updated by unlockNode |
| V-ENM-02 | Preview uses different random results than execution |
| V-ENM-04 | Bleed calculated with stale enemy HP/buffs |
| V-ENM-05 | useEnemyAI is stateless wrapper |
| V-ORCH-08 | phaseCount vs phaseIndex naming confusion |
| V-ORCH-09 | Multi-enemy support bolted on |

**Total remaining:** 7 UI tasks + 2 features + 1 quality task + 28 Tier 3 vulnerabilities

---

## Session 13: New Bug Fixes — User-Reported (Post-Session 12)

**Prerequisites:** Session 2 (save system must be correct)
**Goal:** Fix 4 user-reported bugs: save/load on startup, blacksmith equipment visibility, defeat screen retry, and node map HP tracking.

| ID | File | Issue | Fix |
|----|------|-------|-----|
| BUG-NEW-01 | `PlayerContext.tsx`, `ResourceContext.tsx`, `GameStateContext.tsx` | No auto-load on startup; class always reverts to swordsman | Add startup load flow: call `saveManager.load()` and apply saved data to contexts |
| BUG-NEW-02 | `RepairTab.tsx`, `UpgradeTab.tsx`, `DismantleTab.tsx` | Blacksmith only reads storage items, ignores equipped items | Include `equipmentSlots` items in all Blacksmith tab item lists |
| BUG-NEW-03 | `DefeatScreen.tsx`, `BattleScreen.tsx` | Retry button on defeat screen unnecessary | Remove Retry Battle button and related handler |
| BUG-NEW-04 | `NodeMap.tsx:125,150,158` | HP recovery uses `baseMaxHp` instead of `runtimeState.currentHp` | Replace `baseMaxHp` with `runtimeState.currentHp` |

**Vulnerabilities fixed:** 4
**Verification:**
- Reload browser → character class and resources preserved from save
- Open blacksmith → equipped items visible in Repair/Upgrade/Dismantle tabs
- Defeat screen shows only "Return to Camp" (no Retry button)
- Node map HP recovery event correctly modifies current HP

---

## Progress Tracking

| Session | Vulns | MASTER Tasks | Status |
|---------|-------|--------------|--------|
| 1: State Foundation | 5 | — | ✅ Complete |
| 2: Save & Inventory | 4 | — | ✅ Complete |
| 3: Battle Stale Closures | 6 | — | ✅ Complete |
| 4: Battle Logic | 4 | — | ✅ Complete |
| 5: DoT & Stacks | 6 | — | ✅ Complete |
| 6: Class & Card | 6 | — | ✅ Complete |
| 7: Economy & Dungeon | 7 | — | ✅ Complete (3 fixed, 1 already done, 3 skipped) |
| 8: Dead Code Sweep | 11 | — | ✅ Complete |
| 9: Naming & Organization | 6 | — | ✅ Complete |
| 10: Data-Driven | 4 | — | Pending |
| 11: Large File Refactor | 3 | Q2 | Pending |
| 12: UI & Features | ~28 | U1-U7, F1-F2, Q1 | Pending |
| 13: New Bug Fixes | 4 | — | Pending |
| **Total** | **~81** | **11** | |

### Excluded (Immutable Files)

These vulnerabilities exist in immutable files and cannot be fixed directly:
- **V-CARD-12** (`deck.ts`) — Module-level card counter never resets → add validation at call sites
- **V-CARD-13** (`deckReducter.ts`) — Empty draw+discard pile edge case → add validation at call sites

---

## Regression Checklist (Run After Every Session)

- [ ] `npm run build` succeeds (NodeMap.tsx:252 error resolved in Session 1)
- [ ] Character select → camp → dungeon → battle flow works
- [ ] Save/load preserves all state
- [ ] No console errors during normal gameplay
- [ ] Each character class can enter and complete a battle
