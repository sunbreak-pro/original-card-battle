# Vulnerability Remediation Guide

> 77 vulnerabilities extracted from 15 code_overview documents, prioritized into 4 tiers with safe refactoring order.

## Table of Contents

1. [Tier 0 — Critical (Data Loss / Corruption)](#tier-0--critical)
2. [Tier 1 — High (Gameplay-Breaking)](#tier-1--high)
3. [Tier 2 — Medium (Logic Errors / Edge Cases)](#tier-2--medium)
4. [Tier 3 — Low (Quality / Extensibility / Cleanup)](#tier-3--low)
5. [Cross-Cutting Best Practices](#cross-cutting-best-practices)
6. [Safe Refactoring Order](#safe-refactoring-order)
7. [Testing Strategy](#testing-strategy)

---

## Tier 0 — Critical

Data loss or corruption bugs. Fix before all others.

### V-CS06 — Save System Missing Inventory Coverage

- **File:** `src/domain/save/logic/saveManager.ts:193-232`
- **Problem:** Save misses `inventory` items and `equipmentInventory`. Only `storageItems` and `equipmentSlots` are persisted.
- **Impact:** Player loses items on save/load cycle.
- **Fix:** Add `inventory` and `equipmentInventory` to `SaveData` type and save/load logic.

### V-CS04 / V-PLR-01 — Player ID Regenerates on Every Recomputation

- **File:** `src/contexts/PlayerContext.tsx:772`
- **Problem:** `player_${Date.now()}` inside `useMemo` — ID changes whenever dependencies change.
- **Impact:** Any system caching or comparing player IDs breaks silently.
- **Fix:** Generate ID once with `useRef` or `useState` initializer. Persist through save system.

### V-CS11 / V-INV-01 — Stale playerData Closure in Rapid Operations

- **File:** `src/contexts/InventoryContext.tsx:48`
- **Problem:** All inventory operations read `playerData` from closure. Rapid operations (e.g., opening 6-item equipment pack) overwrite each other.
- **Impact:** Only last operation's changes survive; earlier changes silently lost.
- **Fix:** Use functional updater pattern: `setPlayerData(prev => ...)` for all mutation paths.

### V-CS01 — Dual Resource State Synchronization Drift

- **File:** `src/contexts/PlayerContext.tsx:531-667`
- **Problem:** PlayerContext duplicates gold/magicStones alongside ResourceContext. `addGold` reads stale pre-update ResourceContext value.
- **Impact:** Resource amounts drift between contexts over time.
- **Fix:** Single source of truth — delegate all resource operations to ResourceContext; remove duplicates from PlayerContext.

### V-INV-02 — equipItem Only Removes From Storage, Not equipmentInventory

- **File:** `src/contexts/InventoryContext.tsx:211-216`
- **Problem:** `equipItem()` searches both `storage` and `equipmentInventory`, but removal only filters `storage.items`.
- **Impact:** Item duplication when equipping from equipmentInventory.
- **Fix:** Add removal branch for `equipmentInventory` source.

**Tier 0 Fix Principles:**
- **Single Source of Truth**: Eliminate duplicate state. Resources should live only in ResourceContext.
- **Functional Updaters**: Always use `setState(prev => ...)` for operations depending on current state.
- **Stable IDs**: Generate player ID once at character creation, store it, never recompute.
- **Atomic Operations**: Multi-step inventory changes must happen in a single state update.

---

## Tier 1 — High

Gameplay-breaking bugs that affect core mechanics.

### V-DMG-04 — canAct() Only Checks Stun; Freeze/Stagger Ignored

- **File:** `src/domain/battles/calculators/buffCalculation.ts:135-137`
- **Problem:** `freeze` and `stagger` should prevent acting, but `canAct()` only checks `!map.has("stun")`.
- **Fix:** Add `freeze` and `stagger` to the `canAct()` check. Use data-driven approach: `DISABLING_DEBUFFS.some(d => map.has(d))`.

### V-CARD-02 — Double Guard Application

- **File:** `src/domain/battles/managements/useCardExecution.ts:429-461`
- **Problem:** Guard applied from both `effect.shieldGain` and `card.guardAmount` — defense cards with both get doubled.
- **Fix:** Choose one source of truth for guard. Remove duplicate application path.

### V-CLASS-03 — Resonance Effects Never Applied in Battle

- **File:** `src/domain/characters/player/logic/elementalSystem.ts:170-218`
- **Problem:** `getResonanceEffects()` exists but is never called in battle execution. Only `getDamageModifier()` is used.
- **Impact:** Mage's core resonance mechanic (burn/freeze/stun from chains) is non-functional.
- **Fix:** Call `getResonanceEffects()` in `useCardExecution.ts` after damage calculation and apply returned effects.

### V-ORCH-01 — Stale Closure in executeNextPhaseRef Update Gap

- **File:** `src/domain/battles/managements/useBattleOrchestrator.ts:550-608`
- **Problem:** `executeNextPhaseRef` updates via separate `useEffect`. Between recreation and effect execution, ref points to old function.
- **Fix:** Assign ref immediately after function definition, not in useEffect.

### V-CARD-04 — Heal Uses Stale HP Value

- **File:** `src/domain/battles/managements/useCardExecution.ts:468-483`
- **Problem:** Heal calculation uses pre-reflect-damage `playerHp` from closure. Multiple heals in same card clobber each other.
- **Fix:** Use functional updater: `setPlayerHp(prev => Math.min(prev + healAmount, maxHp))`.

### V-CARD-07 — Auto-Bleed Uses Stale Enemy Buffs

- **File:** `src/domain/battles/managements/useCardExecution.ts:410-421`
- **Problem:** Auto-bleed reads `enemyBuffs` from closure. Last `setEnemyBuffs` call overwrites earlier changes.
- **Fix:** Accumulate all buff changes into a single update, or use functional updater.

### V-CARD-09 — useDeckManage Hardcodes SWORDSMAN_CARDS_ARRAY

- **File:** `src/domain/battles/managements/useDeckManage.ts:70`
- **Problem:** Deck management always uses Swordsman cards. Mage and Summoner classes broken.
- **Fix:** Accept class parameter and select appropriate card array via `getCardDataByClass()`.

### V-CS02 — useGold Race Condition

- **File:** `src/contexts/ResourceContext.tsx:117-145`
- **Problem:** Balance check uses closure-captured value outside `setResources` updater. Two rapid calls can both pass, allowing double-spend.
- **Fix:** Move balance check inside `setResources` functional updater. Return success/failure via ref or callback.

**Tier 1 Fix Principles:**
- **Complete Predicate Coverage**: Use data-driven approach for disabling debuffs.
- **Single Application Path**: Each effect should have exactly one code path.
- **Accumulated State Pattern**: Accumulate changes locally, then apply once via single `setState`.
- **Parameterize Class Data**: Pass card data arrays as parameters, not hardcoded imports.

---

## Tier 2 — Medium

Logic errors and edge cases that affect balance or correctness.

| ID | Location | Issue |
|----|----------|-------|
| V-DMG-01 | `playerPhaseExecution.ts:71-74` | Healing uses pre-duration-decrease buffs (inconsistent with DoT) |
| V-DMG-03 | `damageCalculation.ts:52-57` | Guard bleed-through only when guard fully absorbs + AP=0 (counter-intuitive) |
| V-DMG-05 | `buffCalculation.ts:162-167` | `immunityBuff` return semantics inverted (true=allow, name suggests immune) |
| V-DMG-06 | `bleedDamage.ts` | Bleed damage ignores stacks |
| V-DMG-10 | `buffCalculation.ts:120-124` | Burn/Poison DoT ignores stacks |
| V-CARD-01 / V-CLASS-01 | `useCardExecution.ts:320` | Sword energy bonus uses pre-consumption value |
| V-CARD-03 | `useCardExecution.ts:446-461` | Hardcoded card IDs (sw_037/039/040) for sword energy guard |
| V-CARD-17 | `cardPlayLogic.ts` | `requiresSummon` not enforced in `canPlayCard` |
| V-CLASS-02 | `elementalSystem.ts:47-57` | Non-magic cards reset resonance chain completely |
| V-CLASS-04 | `classAbilitySystem.ts:22-30` | `critBonus` and `penetration` fields never used in damage pipeline |
| V-CLASS-13 | `elementalSystem.ts:48-77` | Dual-element card inconsistent `find` vs `includes` check |
| V-CS03 | `ResourceContext.tsx:224-241` | `useExplorationPoint` returns stale success value |
| V-CS07 | `saveManager.ts:172-186` | `migrate()` is a stub — format changes corrupt saves |
| V-EC-01 | `shopLogic.ts:83-124` | Magic stone exchange overpays without warning |
| V-EC-06 | `saveTypes.ts:29-32` | Save excludes exploration resources |
| V-EC-08 | `ShopData.ts:185-223` | Daily rotation seed not persisted |
| V-EC-12 | `ResourceContext.tsx:267-309` | Transfer multiplier floors per-tier (small stone quantities lost) |
| V-ENM-01 | `enemyAI.ts:23` | `_remainingEnergy` ignored in AI selection |
| V-ENM-02 | `enemyActionExecution.ts:81-114` | Preview uses different random results than execution |
| V-ENM-07 | `enemyActionExecution.ts:65-77` | Fallback action hardcoded 5 damage (doesn't scale with depth) |
| V-INV-07 | `equipmentStats.ts` | Equipment durability never decremented in battle |
| V-DNG-03 | `nodeEventLogic.ts:194` | Trap damage uses negative `hpRestore` (fragile API) |
| V-ORCH-02 | `useBattleOrchestrator.ts:562` | Phase queue expansion uses stale enemies array |
| V-ORCH-03 | `useBattleOrchestrator.ts:648` | `handleEndPhase` reads stale `currentPhaseIndex` |
| V-ORCH-04 | `useBattlePhase.ts:82-111` | `generatePhaseQueueFromSpeeds` double-call uses same random state |

**Tier 2 Fix Principles:**
- **Consistent Buff Timing**: Universal rule for healing vs tick order, enforced identically in player and enemy phases.
- **Stack-Aware DoT**: All stackable effects must multiply `value * stacks`.
- **Data-Driven Card Specials**: Replace hardcoded ID checks with card properties.
- **Seeded Randomness**: Use seeded PRNG for reproducible preview and shop rotation.
- **Save Migration Framework**: Version-based migration chain.

---

## Tier 3 — Low

Quality, extensibility, and cleanup. Address opportunistically when touching related code.

### Dead Code / Duplicates

| ID | Summary | File |
|----|---------|------|
| V-CARD-05/10 | Duplicate `calculateCardEffect` in card.ts + cardPlayLogic.ts | `card.ts`, `cardPlayLogic.ts` |
| V-CARD-11 | `processSwordEnergyConsumption` returns unused `damageBonus: 0` | `CardHandle.ts:49` |
| V-DMG-09 | Deprecated `decreaseBuffDebuffDuration` coexists with new version | `buffLogic.ts:94-110` |
| V-ORCH-06 | `useEnemyAI` return value discarded | `useBattleOrchestrator.ts:405` |
| V-ORCH-07 | Legacy deprecated aliases in orchestrator return object | `useBattleOrchestrator.ts:800-882` |
| V-CS12 | Battle state dual API surface (35 lines duplication) | `useBattleState.ts:460-494` |
| V-INV-03 | Duplicate move directions (`equipment_to_storage` = `equipSlotItem_to_storage`) | `InventoryContext.tsx:441-519` |
| V-CLASS-08 | Three identical hook wrappers (~160 lines duplication) | `useClassAbility.ts` etc. |
| V-ENM-06 | Duplicate guard-only check in two files | `enemyPhaseExecution.ts`, `useEnemyAI.ts` |

### Duplicate Constants

| ID | Summary | File |
|----|---------|------|
| V-CLASS-10 | `SWORD_ENERGY_MAX` defined in two places | `classAbilityUtils.ts:15`, `characterConstants.ts:30` |
| V-CLASS-11 | `DEFAULT_DAMAGE_MODIFIER` defined in two places | `classAbilitySystem.ts:35`, `characterConstants.ts:37` |

### File Size / SRP Violations

| ID | Summary | File |
|----|---------|------|
| V-CS05 | PlayerContext is 939 lines | `PlayerContext.tsx` |
| V-ORCH-05 | Orchestrator is 882 lines | `useBattleOrchestrator.ts` |

### Naming Typos

| ID | Summary | File |
|----|---------|------|
| V-CARD-15 | "SwordmanCards" → "SwordsmanCards" | `SwordmanCards.ts` |
| V-PLR-07 | "tittle.ts" → "title.ts" | `tittle.ts` |
| V-DNG-06 | "deptManager.ts" → "depthManager.ts" | `deptManager.ts` |

### Stub / Incomplete Systems

| ID | Summary | File |
|----|---------|------|
| V-CLASS-09 / V-PLR-03 | SummonSystem mostly stub (3 hardcoded summons) | `summonSystem.ts` |
| V-PLR-06 | Title functions disconnected from gameplay | `tittle.ts` |
| V-DMG-11 | Weakness/prostoration defined but unused | `buffCalculation.ts` |

### Test Data in Production

| ID | Summary | File |
|----|---------|------|
| V-CS08 / V-EC-11 | Hardcoded test gold/stones in production init | `ResourceContext.tsx:67-81` |
| V-INV-05 | Test items loaded in production build (273 lines) | `TestItemsData.ts` |

### Hardcoded Patterns / Extensibility

| ID | Summary | File |
|----|---------|------|
| V-DMG-07 | Attack/defense buffs are hardcoded if-chains | `buffCalculation.ts:9-62` |
| V-DMG-08 | No damage type system (single pipeline) | `damageCalculation.ts` |
| V-CARD-08 | `calculateCardEffect` only handles 3 of 6 categories | `card.ts:58-68` |

### Misc Logic / Balance / Architecture

| ID | Summary |
|----|---------|
| V-DMG-02 | Curse + OverCurse stacking reduces heal to 10% |
| V-CARD-12 | Module-level card counter never resets (**IMMUTABLE file**) |
| V-CARD-13 | Empty draw+discard pile edge case (**IMMUTABLE file**) |
| V-CARD-14 | Card `id` equals `cardTypeId` — duplicates share same ID |
| V-CARD-18 | `getMasteryBonus` returns decimal; callers must add 1.0 |
| V-CLASS-05 | `combineDamageModifiers` multiplies (not additive) |
| V-CLASS-06 | Summoner bondLevel starts at 1 (immediate 5% bonus) |
| V-CLASS-07 | 8 empty resonance effect entries |
| V-CLASS-12 | Sword energy `_card` parameter unused |
| V-INV-04 | Capacity tracked manually instead of `items.length` |
| V-INV-06 | No item stacking for consumables |
| V-CS09 | Quest expiry uses `Date` object (won't survive JSON) |
| V-EC-02 | Equipment packs skip uncommon rarity |
| V-EC-03 | Quality upgrade consumes resources on failure |
| V-EC-04 | Sanctuary effects recalculated every call (no cache) |
| V-EC-05 | Dismantle returns very low value for common items |
| V-EC-07 | Common/uncommon share identical upgrade costs |
| V-EC-09 | No endgame gold sink |
| V-EC-10 | `explorationLimitBonus` not updated by `unlockNode` |
| V-DNG-01 | Map generation uses unseeded `Math.random()` |
| V-DNG-02 | Floor advancement doesn't escalate difficulty |
| V-DNG-04 | DungeonRunContext in `src/ui/` instead of `src/contexts/` |
| V-DNG-05 | Node connections can create unreachable nodes |
| V-DNG-07 | `encounterCount` inflated by non-battle nodes |
| V-ENM-03 | Enemy actions always `element: ["physics"]` |
| V-ENM-04 | Bleed calculated with stale enemy HP/buffs |
| V-ENM-05 | `useEnemyAI` is stateless wrapper |
| V-ORCH-08 | `phaseCount` vs `phaseIndex` naming confusion |
| V-ORCH-09 | Multi-enemy support bolted on |

**Tier 3 Fix Principles:**
- **Delete Before Refactor**: Remove dead code outright, don't comment out.
- **Canonical Constants**: One export location per constant.
- **Extract, Don't Rewrite**: Break large files by extracting hooks, not rewriting.
- **Rename in Bulk**: Fix typos in a single commit with updated imports.

---

## Cross-Cutting Best Practices

### 1. Stale Closure Prevention (10+ vulnerabilities)

The most pervasive issue. Affects: card execution, battle orchestration, inventory, resources, enemy AI.

```typescript
// BAD — reads stale closure value
const handleHeal = () => {
  setPlayerHp(playerHp + healAmount); // playerHp may be stale
};

// GOOD — reads latest value
const handleHeal = () => {
  setPlayerHp(prev => Math.min(prev + healAmount, maxHp));
};
```

**For complex multi-field updates — Accumulated Changes Pattern:**

```typescript
function executeCard(card) {
  const changes = { hp: 0, guard: 0, enemyHp: 0, buffs: new Map(currentBuffs) };

  // All calculations mutate local object, not React state
  changes.enemyHp -= calculateDamage(...);
  changes.hp += calculateHeal(...);
  changes.guard += calculateGuard(...);

  // Single commit
  setPlayerHp(prev => Math.min(prev + changes.hp, maxHp));
  setPlayerGuard(prev => prev + changes.guard);
  setEnemyHp(prev => prev + changes.enemyHp);
  setEnemyBuffs(changes.buffs);
}
```

**For refs wrapping callbacks:** Assign `.current` immediately after function definition, not in useEffect.

### 2. Single Source of Truth for State

```
RULE: One owner per piece of state. Readers observe; they never copy.

BAD:  ResourceContext owns gold → PlayerContext copies gold → drift
GOOD: ResourceContext owns gold → PlayerContext reads via useResources()
```

- Never maintain the same data in two contexts
- For multi-step operations (equip: remove + set slot + add displaced), batch into single state update

### 3. Data-Driven Design Over Hardcoding

```typescript
// BAD — hardcoded card ID check
if (card.id === 'sw_037' || card.id === 'sw_039' || card.id === 'sw_040') {
  convertEnergyToGuard();
}

// GOOD — card data declares capability
if (card.convertEnergyToGuard) {
  convertEnergyToGuard();
}

// BAD — hardcoded buff check
canAct = !map.has("stun")

// GOOD — data-driven
canAct = !DISABLING_DEBUFFS.some(d => map.has(d))
```

### 4. Consistency Rules

| Aspect | Rule |
|--------|------|
| Buff timing | Choose "healing before tick" OR "after tick" — apply uniformly to both phases |
| Stack effects | If `stackable: true`, the effect formula MUST include `* stacks` |
| Damage pipeline | All damage should flow through `applyDamageAllocation` |
| Save coverage | Every persistent field in PlayerData/ResourceState must appear in SaveData |
| Randomness | UI-visible predictions (enemy preview) must use the same seed as execution |

### 5. Immutable File Awareness

Two files MUST NOT be modified:

- `src/domain/cards/decks/deck.ts` (V-CARD-12: counter never resets)
- `src/domain/cards/decks/deckReducter.ts` (V-CARD-13: empty pile edge case)

Work around these by adding validation at call sites.

---

## Safe Refactoring Order

Dependencies between fixes require a phased approach. Each phase can be done in parallel within itself but must complete before the next.

### Phase 1: State Foundation (No gameplay changes)

Fix the state management bugs first — they affect every other system.

1. **V-CS01** — Remove resource duplication from PlayerContext → delegate to ResourceContext
2. **V-CS04** — Stabilize player ID (`useRef` / `useState` initializer)
3. **V-CS11** — Convert all inventory operations to functional updaters
4. **V-CS02** — Move `useGold` balance check inside functional updater
5. **V-CS03** — Fix `useExplorationPoint` return value

**Verification:** Save → reload → verify gold, stones, inventory unchanged.

### Phase 2: Save System Integrity

Depends on Phase 1 (state must be correct before saving).

1. **V-CS06** — Add missing inventory/equipmentInventory to SaveData
2. **V-EC-06** — Add exploration resources to save
3. **V-CS07** — Implement basic save migration (version check + field addition)
4. **V-INV-02** — Fix equipItem removal from equipmentInventory

**Verification:** Full save/load cycle with items in all storage locations.

### Phase 3: Battle Core Fixes

Depends on Phase 1 (functional updaters required).

1. **V-CARD-04** — Heal uses functional updater for HP
2. **V-CARD-07** — Auto-bleed accumulates with other buff changes
3. **V-ORCH-01** — Fix executeNextPhaseRef update gap
4. **V-DMG-04** — Add freeze/stagger to `canAct()`
5. **V-CARD-02** — Remove double guard application
6. **V-CARD-09** — Make useDeckManage class-aware

**Verification:** Play 5 battles as each class. Verify guard values, bleed application, freeze/stagger behavior.

### Phase 4: Class Mechanics & Consistency

Depends on Phase 3 (battle core must be stable).

1. **V-CLASS-03** — Wire resonance effects into battle execution
2. **V-DMG-06** — Bleed damage * stacks
3. **V-DMG-10** — Burn/poison DoT * stacks
4. **V-CLASS-13** — Fix dual-element chain logic
5. **V-CLASS-04** — Wire critBonus/penetration into damage pipeline (or remove dead code)
6. **V-DMG-01** — Consistent buff timing (healing vs duration decrease order)
7. **V-ENM-02** — Seeded randomness for enemy preview

**Verification:** Play Mage through 3 depths. Verify resonance effects trigger. Verify stacked DoTs deal proportional damage.

### Phase 5: Quality & Cleanup (Independent — any order)

- Remove dead code (V-CARD-05/10, V-DMG-09, V-ORCH-06/07)
- Consolidate duplicate constants (V-CLASS-10/11)
- Fix naming typos (V-CARD-15, V-PLR-07, V-DNG-06)
- Remove test data from production (V-CS08, V-INV-05)
- Replace hardcoded patterns with data-driven approach (V-CARD-03, V-DMG-07)
- File reorganization (V-DNG-04: move DungeonRunContext to `src/contexts/`)
- Extract PlayerContext subsystems (V-CS05)

---

## Testing Strategy

No test framework is configured. All verification is manual in-browser.

### Critical Path Tests (Phases 1–2)

| Test | Steps | Expected |
|------|-------|----------|
| Save integrity | Buy item → equip → save → reload | All items preserved in correct locations |
| Resource consistency | Buy item rapidly 3x → check gold | Gold decremented exactly 3x item price |
| Inventory rapid ops | Open 6-item pack quickly | All 6 items appear in inventory |
| Player ID stability | Navigate between screens 5x | Same player ID throughout |

### Battle Tests (Phases 3–4)

| Test | Steps | Expected |
|------|-------|----------|
| Stun/Freeze/Stagger | Apply freeze to enemy → their turn | Enemy skips turn |
| Guard single source | Play defense card → check guard value | Guard = ONE of shieldGain or guardAmount, not both |
| Heal after reflect | Play card that reflects + heals | HP reflects both damage and heal correctly |
| Bleed stacks | Apply bleed 3x → enemy turn | Bleed damage = `floor(maxHp * rate) * 3` |
| Mage resonance | Chain 3 fire cards → check enemy | Burn debuff applied to enemy |
| Class deck | Start battle as Mage | Deck contains Mage cards, not Swordsman |

### Regression Checklist

After any fix, verify:

- [ ] `npm run build` succeeds (ignore known NodeMap.tsx:252 error)
- [ ] Character select → camp → dungeon → battle flow works
- [ ] Save/load preserves all state
- [ ] No console errors during normal gameplay
- [ ] Each character class can enter and complete a battle

---

## Vulnerability Count Summary

| Tier | Count | Category |
|------|-------|----------|
| 0 (Critical) | 5 | Data loss / corruption |
| 1 (High) | 8 | Gameplay-breaking |
| 2 (Medium) | 25 | Logic errors / edge cases |
| 3 (Low) | 39 | Quality / extensibility / cleanup |
| **Total** | **77** | |

**Cross-cutting patterns:** Stale closures (10+), duplicate state/code (8+), stub systems (7), hardcoded logic (5+), inconsistent buff handling (5+), naming typos (3).
