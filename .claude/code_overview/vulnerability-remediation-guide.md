# Vulnerability Remediation Guide

> 106 vulnerabilities tracked across 15+ code_overview documents, prioritized into 4 tiers with safe refactoring order. 19 fixed, 87 remaining.

## Table of Contents

1. [Tier 0 — Critical (Data Loss / Corruption)](#tier-0--critical)
2. [Tier 1 — High (Gameplay-Breaking)](#tier-1--high)
3. [Tier 2 — Medium (Logic Errors / Edge Cases)](#tier-2--medium)
4. [Tier 3 — Low (Quality / Extensibility / Cleanup)](#tier-3--low)
5. [Cross-Cutting Best Practices](#cross-cutting-best-practices)
6. [Safe Refactoring Order](#safe-refactoring-order)
7. [Testing Strategy](#testing-strategy)

---

## Tier 0 — Critical

Data loss or corruption bugs. Fix before all others.

### V-CS06 — Save System Missing Inventory Coverage ✅ FIXED (Session 2)

- **File:** `src/domain/save/logic/saveManager.ts:193-232`
- **Problem:** Save misses `inventory` items and `equipmentInventory`. Only `storageItems` and `equipmentSlots` are persisted.
- **Impact:** Player loses items on save/load cycle.
- **Fix:** ✅ Added `inventory` and `equipmentInventory` to `SaveData` type and save/load logic. (Session 2)

### V-CS04 / V-PLR-01 — Player ID Regenerates on Every Recomputation ✅ FIXED (Session 1)

- **File:** `src/contexts/PlayerContext.tsx`
- **Problem:** `player_${Date.now()}` inside `useMemo` — ID changes whenever dependencies change.
- **Impact:** Any system caching or comparing player IDs breaks silently.
- **Fix:** ✅ ID generated once via `useState` initializer; persisted through save system. (Session 1)

### V-CS11 / V-INV-01 — Stale playerData Closure in Rapid Operations ✅ FIXED (Session 1)

- **File:** `src/contexts/InventoryContext.tsx`
- **Problem:** All inventory operations read `playerData` from closure. Rapid operations (e.g., opening 6-item equipment pack) overwrite each other.
- **Impact:** Only last operation's changes survive; earlier changes silently lost.
- **Fix:** ✅ All inventory mutations converted to `setPlayerData(prev => ...)` functional updater pattern. (Session 1)

### V-CS01 — Dual Resource State Synchronization Drift ✅ FIXED (Session 1)

- **File:** `src/contexts/PlayerContext.tsx`
- **Problem:** PlayerContext duplicates gold/magicStones alongside ResourceContext. `addGold` reads stale pre-update ResourceContext value.
- **Impact:** Resource amounts drift between contexts over time.
- **Fix:** ✅ All resource operations removed from PlayerContext. Consumers use `useResources()` directly. (Session 1)

### V-INV-02 — equipItem Only Removes From Storage, Not equipmentInventory ✅ FIXED (Session 2)

- **File:** `src/contexts/InventoryContext.tsx:211-216`
- **Problem:** `equipItem()` searches both `storage` and `equipmentInventory`, but removal only filters `storage.items`.
- **Impact:** Item duplication when equipping from equipmentInventory.
- **Fix:** ✅ Added removal branch for `equipmentInventory` source. (Session 2)

### V-EXEC-01 — Dead entities continue acting (checkCharacterHp stale)

- **File:** `src/domain/battles/managements/executeCharacterManage.ts:210`
- **Problem:** `checkCharacterHp = () => ctx.playerHp <= 0 || ctx.enemyHp <= 0` captures HP at phase start. After `setPlayerHp`/`setEnemyHp`, old values persist. Enemy kills player on first attack → subsequent attacks still execute.
- **Impact:** Dead entities keep fighting. Incorrect battle outcomes.
- **Fix:** Track accumulated HP changes in local variable, check against `ctx.playerHp - accumulatedDamage`.

### V-EXEC-02 — Enemy multi-action debuffs overwrite

- **File:** `src/domain/battles/managements/executeCharacterManage.ts:254-256`
- **Problem:** `applyEnemyDebuffsToPlayer(ctx.playerBuffs, action.applyDebuffs)` always starts from original `ctx.playerBuffs`. Second action's debuffs overwrite first.
- **Impact:** Only last action's debuffs survive in multi-action phases.
- **Fix:** `ctx.setPlayerBuffs(prev => applyEnemyDebuffsToPlayer(prev, action.applyDebuffs))`

**Tier 0 Fix Principles:**
- **Single Source of Truth**: Eliminate duplicate state. Resources should live only in ResourceContext.
- **Functional Updaters**: Always use `setState(prev => ...)` for operations depending on current state.
- **Stable IDs**: Generate player ID once at character creation, store it, never recompute.
- **Atomic Operations**: Multi-step inventory changes must happen in a single state update.
- **HP Liveness Checks**: Never check HP from closure in async loops — track accumulated damage locally.

---

## Tier 1 — High

Gameplay-breaking bugs that affect core mechanics.

### V-DMG-04 — canAct() Only Checks Stun; Freeze/Stagger Ignored ✅ FIXED (Session 4)

- **File:** `src/domain/battles/calculators/buffCalculation.ts:135-137`
- **Problem:** `freeze` and `stagger` should prevent acting, but `canAct()` only checks `!map.has("stun")`.
- **Fix:** ✅ Added `freeze` and `stagger` to the `canAct()` check using data-driven approach. (Session 4)

### V-CARD-02 — Double Guard Application ✅ FIXED (Session 4)

- **File:** `src/domain/battles/managements/useCardExecution.ts:429-461`
- **Problem:** Guard applied from both `effect.shieldGain` and `card.guardAmount` — defense cards with both get doubled.
- **Fix:** ✅ Removed duplicate application path; single source of truth for guard. (Session 4)

### V-CLASS-03 — Resonance Effects Never Applied in Battle ✅ FIXED (Session 4)

- **File:** `src/domain/characters/player/logic/elementalSystem.ts:170-218`
- **Problem:** `getResonanceEffects()` exists but is never called in battle execution. Only `getDamageModifier()` is used.
- **Impact:** Mage's core resonance mechanic (burn/freeze/stun from chains) is non-functional.
- **Fix:** ✅ Wired `getResonanceEffects()` into `useCardExecution.ts` after damage calculation. (Session 4)

### V-ORCH-01 — Stale Closure in executeNextPhaseRef Update Gap ✅ FIXED (Session 3)

- **File:** `src/domain/battles/managements/useBattleOrchestrator.ts:550-608`
- **Problem:** `executeNextPhaseRef` updates via separate `useEffect`. Between recreation and effect execution, ref points to old function.
- **Fix:** ✅ Ref assigned immediately after function definition, not in useEffect. (Session 3)

### V-CARD-04 — Heal Uses Stale HP Value ✅ FIXED (Session 3)

- **File:** `src/domain/battles/managements/useCardExecution.ts:468-483`
- **Problem:** Heal calculation uses pre-reflect-damage `playerHp` from closure. Multiple heals in same card clobber each other.
- **Fix:** ✅ Converted to functional updater: `setPlayerHp(prev => Math.min(prev + healAmount, maxHp))`. (Session 3)

### V-CARD-07 — Auto-Bleed Uses Stale Enemy Buffs ✅ FIXED (Session 3)

- **File:** `src/domain/battles/managements/useCardExecution.ts:410-421`
- **Problem:** Auto-bleed reads `enemyBuffs` from closure. Last `setEnemyBuffs` call overwrites earlier changes.
- **Fix:** ✅ Accumulated all buff changes into a single update using functional updater. (Session 3)

### V-CARD-09 — useDeckManage Hardcodes SWORDSMAN_CARDS_ARRAY ✅ FIXED (Session 4)

- **File:** `src/domain/battles/managements/useDeckManage.ts:70`
- **Problem:** Deck management always uses Swordsman cards. Mage and Summoner classes broken.
- **Fix:** ✅ Accepts class parameter and selects appropriate card array via `getCardDataByClass()`. (Session 4)

### V-CS02 — useGold Race Condition ✅ FIXED (Session 1)

- **File:** `src/contexts/ResourceContext.tsx`
- **Problem:** Balance check uses closure-captured value outside `setResources` updater. Two rapid calls can both pass, allowing double-spend.
- **Fix:** ✅ Balance check moved inside functional updater. Success/failure returned via mutable result object. (Session 1)

### V-EXEC-03 — Multi-hit damage allocation stale guard/AP

- **File:** `src/domain/battles/managements/useCardExecution.ts:339-401`
- **Problem:** `applyDamageAllocation(enemyStats, ...)` uses captured stats. Hit 2 still allocates damage to guard destroyed by hit 1.
- **Impact:** Multi-hit cards do less effective damage than intended.
- **Fix:** Track running guard/AP totals in local variables across hits.

### V-EXEC-04 — Enemy turnCount never incremented

- **File:** `src/domain/battles/managements/executeCharacterManage.ts:269`
- **Problem:** `turnCount` initialized to 0, never incremented. `?? 1` fallback → AI always sees turn 1.
- **Impact:** Turn-based AI patterns (e.g., "special on turn 3") never activate.
- **Fix:** Increment `turnCount` at the end of each enemy phase.

### V-PHASE-01 — Enemy healing uses pre-duration-decrease buffs

- **File:** `src/domain/battles/execution/enemyPhaseExecution.ts:91`
- **Problem:** `calculateStartPhaseHealing(enemyBuffs)` instead of `calculateStartPhaseHealing(newBuffs)`. Player-side (`playerPhaseExecution.ts:74`) correctly uses `newBuffs`.
- **Impact:** Enemy heals from expired regeneration.
- **Fix:** Change to `calculateStartPhaseHealing(newBuffs)`.

### V-PHASE-02 — Enemy canAct uses pre-duration-decrease buffs

- **File:** `src/domain/battles/execution/enemyPhaseExecution.ts:100`
- **Problem:** `canAct(enemyBuffs)` instead of `canAct(newBuffs)`. Expired stun still blocks action.
- **Impact:** Stun lasts one extra turn for enemies.
- **Fix:** Change to `canAct(newBuffs)`.

### V-DMG-MANAGE-01 — damageManage.ts wrong parameter order

- **File:** `src/domain/battles/managements/damageManage.ts:59-68`
- **Problem:** `addOrUpdateBuffDebuff(map, name, stacks, duration, value, ...)` — signature expects `(map, name, duration, value, stacks)`. Also missing `appliedBy: 'enemy'`.
- **Note:** Correct version exists in `enemyPhaseExecution.ts:224-236`. This file may be dead code but is dangerous if imported.
- **Fix:** Correct parameter order or delete if dead code.

**Tier 1 Fix Principles:**
- **Complete Predicate Coverage**: Use data-driven approach for disabling debuffs.
- **Single Application Path**: Each effect should have exactly one code path.
- **Accumulated State Pattern**: Accumulate changes locally, then apply once via single `setState`.
- **Parameterize Class Data**: Pass card data arrays as parameters, not hardcoded imports.
- **Phase Buff Consistency**: Always use post-duration-decrease buffs for phase calculations.

---

## Tier 2 — Medium

Logic errors and edge cases that affect balance or correctness.

| ID | Location | Issue |
|----|----------|-------|
| V-DMG-01 | `playerPhaseExecution.ts:71-74` | Healing uses pre-duration-decrease buffs (inconsistent with DoT) |
| V-DMG-03 | `damageCalculation.ts:52-57` | Guard bleed-through only when guard fully absorbs + AP=0 (counter-intuitive) |
| V-DMG-05 | `buffCalculation.ts:162-167` | `immunityBuff` return semantics inverted (true=allow, name suggests immune) |
| V-DMG-06 | `bleedDamage.ts` | Bleed damage ignores stacks |
| V-DMG-10 | `buffCalculation.ts:120-124` | Burn/Poison DoT ignores stacks |
| V-CARD-01 / V-CLASS-01 | `useCardExecution.ts:320` | Sword energy bonus uses pre-consumption value |
| V-CARD-03 | `useCardExecution.ts:446-461` | Hardcoded card IDs (sw_037/039/040) for sword energy guard |
| V-CARD-17 | `cardPlayLogic.ts` | `requiresSummon` not enforced in `canPlayCard` |
| V-CLASS-02 | `elementalSystem.ts:47-57` | Non-magic cards reset resonance chain completely |
| V-CLASS-04 | `classAbilitySystem.ts:22-30` | `critBonus` and `penetration` fields never used in damage pipeline |
| V-CLASS-13 | `elementalSystem.ts:48-77` | Dual-element card inconsistent `find` vs `includes` check |
| V-CS03 | `ResourceContext.tsx` | ✅ FIXED (Session 1) — `useExplorationPoint` stale success value fixed via mutable result object |
| V-CS07 | `saveManager.ts:172-186` | ✅ FIXED (Session 2) — `migrate()` stub implemented with version-based migration |
| V-EC-01 | `shopLogic.ts:83-124` | Magic stone exchange overpays without warning |
| V-EC-06 | `saveTypes.ts:29-32` | ✅ FIXED (Session 2) — Exploration resources added to save |
| V-EC-08 | `ShopData.ts:185-223` | Daily rotation seed not persisted |
| V-EC-12 | `ResourceContext.tsx:267-309` | Transfer multiplier floors per-tier (small stone quantities lost) |
| V-ENM-01 | `enemyAI.ts:23` | `_remainingEnergy` ignored in AI selection |
| V-ENM-02 | `enemyActionExecution.ts:81-114` | Preview uses different random results than execution |
| V-ENM-07 | `enemyActionExecution.ts:65-77` | Fallback action hardcoded 5 damage (doesn't scale with depth) |
| V-INV-07 | `equipmentStats.ts` | Equipment durability never decremented in battle |
| V-DNG-03 | `nodeEventLogic.ts:194` | Trap damage uses negative `hpRestore` (fragile API) |
| V-ORCH-02 | `useBattleOrchestrator.ts:562` | ✅ FIXED (Session 3) — Phase queue expansion stale enemies array fixed |
| V-ORCH-03 | `useBattleOrchestrator.ts:648` | ✅ FIXED (Session 3) — `handleEndPhase` stale `currentPhaseIndex` fixed |
| V-ORCH-04 | `useBattlePhase.ts:82-111` | ✅ FIXED (Session 3) — `generatePhaseQueueFromSpeeds` double-call random state fixed |
| V-EXEC-05 | `executeCharacterManage.ts:282` | Enemy phase-end DoT uses stale `ctx.enemyBuffs` |
| V-EXEC-06 | `useBattleOrchestrator.ts:573-622` | `executeNextPhaseImpl` captures stale `areAllEnemiesDead`/`isPlayerAlive` |
| V-CHAIN-01 | `useBattleOrchestrator.ts:368-375, 422-428` | Mage resonance one card behind — `executeCard` runs before `onCardPlayed` |
| V-STATE-01 | `useBattleState.ts:213` | `enemyEnergy` state never synced with per-enemy energy |
| V-EXEC-07 | `useCardExecution.ts:291-304` | Side-effect mutation inside `setSwordEnergy` updater (concurrent mode unsafe) |
| V-CARD-NEW-01 | `card.ts:7` vs `cardConstants.ts:35-41` | `MASTERY_BONUSES` constant disagrees with `calculateEffectivePower` formula |
| V-CARD-NEW-02 | `damageCalculation.ts` | `penetration` card property never used in damage pipeline |
| V-CARD-NEW-03 | `useCardExecution.ts` | `requiresSummon` not validated (supplements existing V-CARD-17) |
| V-CARD-NEW-04 | Cards sw_002, sm_018 | `nextCardCostReduction` defined but never implemented |
| V-CARD-NEW-05 | `cardDerivation.ts:97-103` | Infinite loop in ancestor trace — no cycle detection |
| V-UI-01 | `VictoryScreen.tsx:150-155` | Continue button — no double-click protection, duplicate rewards |
| V-UI-02 | `Guild.tsx:20` | Incorrect relative image path — broken in production |
| V-UI-03 | `BattleScreen.tsx:358-376` | Nested setTimeout without cleanup — unmounted state updates |
| V-UI-04 | `BuyTab.tsx:26-29` | Expensive functions recalculated every render |
| V-UI-05 | `Storage.tsx:439-465` | Stale `selectedItem` + non-null assertion after mutation |

**Tier 2 Fix Principles:**
- **Consistent Buff Timing**: Universal rule for healing vs tick order, enforced identically in player and enemy phases.
- **Stack-Aware DoT**: All stackable effects must multiply `value * stacks`.
- **Data-Driven Card Specials**: Replace hardcoded ID checks with card properties.
- **Seeded Randomness**: Use seeded PRNG for reproducible preview and shop rotation.
- **Save Migration Framework**: Version-based migration chain.
- **UI Safety**: Debounce irreversible actions; clean up timers on unmount.

---

## Tier 3 — Low

Quality, extensibility, and cleanup. Address opportunistically when touching related code.

### Dead Code / Duplicates

| ID | Summary | File |
|----|---------|------|
| V-CARD-05/10 | Duplicate `calculateCardEffect` in card.ts + cardPlayLogic.ts | `card.ts`, `cardPlayLogic.ts` |
| V-CARD-11 | `processSwordEnergyConsumption` returns unused `damageBonus: 0` | `CardHandle.ts:49` |
| V-DMG-09 | Deprecated `decreaseBuffDebuffDuration` coexists with new version | `buffLogic.ts:94-110` |
| V-ORCH-06 | `useEnemyAI` return value discarded | `useBattleOrchestrator.ts:405` |
| V-ORCH-07 | Legacy deprecated aliases in orchestrator return object | `useBattleOrchestrator.ts:800-882` |
| V-CS12 | Battle state dual API surface (35 lines duplication) | `useBattleState.ts:460-494` |
| V-INV-03 | Duplicate move directions (`equipment_to_storage` = `equipSlotItem_to_storage`) | `InventoryContext.tsx:441-519` |
| V-CLASS-08 | Three identical hook wrappers (~160 lines duplication) | `useClassAbility.ts` etc. |
| V-ENM-06 | Duplicate guard-only check in two files | `enemyPhaseExecution.ts`, `useEnemyAI.ts` |
| V-CODE-01 | `phaseLogic.ts` uses deprecated `decreaseBuffDebuffDuration` | `phaseLogic.ts` |
| V-CODE-02 | Duplicate `calculateCardEffect`, `canPlayCard`, `calculateMasteryLevel` | Multiple files |

### Duplicate Constants

| ID | Summary | File |
|----|---------|------|
| V-CLASS-10 | `SWORD_ENERGY_MAX` defined in two places | `classAbilityUtils.ts:15`, `characterConstants.ts:30` |
| V-CLASS-11 | `DEFAULT_DAMAGE_MODIFIER` defined in two places | `classAbilitySystem.ts:35`, `characterConstants.ts:37` |

### File Size / SRP Violations

| ID | Summary | File |
|----|---------|------|
| V-CS05 | PlayerContext is 939 lines | `PlayerContext.tsx` |
| V-ORCH-05 | Orchestrator is 882 lines | `useBattleOrchestrator.ts` |

### Naming Typos

| ID | Summary | File |
|----|---------|------|
| V-CARD-15 | "SwordmanCards" → "SwordsmanCards" | `SwordmanCards.ts` |
| V-PLR-07 | "tittle.ts" → "title.ts" | `tittle.ts` |
| V-DNG-06 | "deptManager.ts" → "depthManager.ts" | `deptManager.ts` |

### Stub / Incomplete Systems

| ID | Summary | File |
|----|---------|------|
| V-CLASS-09 / V-PLR-03 | SummonSystem mostly stub (3 hardcoded summons) | `summonSystem.ts` |
| V-PLR-06 | Title functions disconnected from gameplay | `tittle.ts` |
| V-DMG-11 | Weakness/prostoration defined but unused | `buffCalculation.ts` |

### Test Data in Production

| ID | Summary | File |
|----|---------|------|
| V-CS08 / V-EC-11 | Hardcoded test gold/stones in production init | `ResourceContext.tsx:67-81` |
| V-INV-05 | Test items loaded in production build (273 lines) | `TestItemsData.ts` |

### Hardcoded Patterns / Extensibility

| ID | Summary | File |
|----|---------|------|
| V-DMG-07 | Attack/defense buffs are hardcoded if-chains | `buffCalculation.ts:9-62` |
| V-DMG-08 | No damage type system (single pipeline) | `damageCalculation.ts` |
| V-CARD-08 | `calculateCardEffect` only handles 3 of 6 categories | `card.ts:58-68` |

### Performance

| ID | Summary | File |
|----|---------|------|
| V-PERF-01 | Context values not memoized (PlayerContext, InventoryContext, GameStateContext) | Multiple contexts |
| V-PERF-02 | `cardSetters` useMemo invalidated by `abilityState` object identity | `useBattleOrchestrator.ts` |
| V-PERF-03 | Notification setTimeout not cleaned up (BuyTab, Sanctuary, Storage) | Multiple UI files |

### Unused Props / Logic

| ID | Summary | File |
|----|---------|------|
| V-CODE-03 | `unlockedCardTypeIds` initialized with Swordsman IDs for all classes | `PlayerContext.tsx` |
| V-UI-06 | BattleScreen `onDepthChange` prop declared but never used | `BattleScreen.tsx` |

### Misc Logic / Balance / Architecture

| ID | Summary |
|----|---------|
| V-DMG-02 | Curse + OverCurse stacking reduces heal to 10% |
| V-CARD-12 | Module-level card counter never resets (**IMMUTABLE file**) |
| V-CARD-13 | Empty draw+discard pile edge case (**IMMUTABLE file**) |
| V-CARD-14 | Card `id` equals `cardTypeId` — duplicates share same ID |
| V-CARD-18 | `getMasteryBonus` returns decimal; callers must add 1.0 |
| V-CLASS-05 | `combineDamageModifiers` multiplies (not additive) |
| V-CLASS-06 | Summoner bondLevel starts at 1 (immediate 5% bonus) |
| V-CLASS-07 | 8 empty resonance effect entries |
| V-CLASS-12 | Sword energy `_card` parameter unused |
| V-INV-04 | Capacity tracked manually instead of `items.length` |
| V-INV-06 | No item stacking for consumables |
| V-CS09 | Quest expiry uses `Date` object (won't survive JSON) |
| V-EC-02 | Equipment packs skip uncommon rarity |
| V-EC-03 | Quality upgrade consumes resources on failure |
| V-EC-04 | Sanctuary effects recalculated every call (no cache) |
| V-EC-05 | Dismantle returns very low value for common items |
| V-EC-07 | Common/uncommon share identical upgrade costs |
| V-EC-09 | No endgame gold sink |
| V-EC-10 | `explorationLimitBonus` not updated by `unlockNode` |
| V-DNG-01 | Map generation uses unseeded `Math.random()` |
| V-DNG-02 | Floor advancement doesn't escalate difficulty |
| V-DNG-04 | DungeonRunContext in `src/ui/` instead of `src/contexts/` |
| V-DNG-05 | Node connections can create unreachable nodes |
| V-DNG-07 | `encounterCount` inflated by non-battle nodes |
| V-ENM-03 | Enemy actions always `element: ["physics"]` |
| V-ENM-04 | Bleed calculated with stale enemy HP/buffs |
| V-ENM-05 | `useEnemyAI` is stateless wrapper |
| V-ORCH-08 | `phaseCount` vs `phaseIndex` naming confusion |
| V-ORCH-09 | Multi-enemy support bolted on |

**Tier 3 Fix Principles:**
- **Delete Before Refactor**: Remove dead code outright, don't comment out.
- **Canonical Constants**: One export location per constant.
- **Extract, Don't Rewrite**: Break large files by extracting hooks, not rewriting.
- **Rename in Bulk**: Fix typos in a single commit with updated imports.
- **Memoize Context Values**: Wrap provider values in `useMemo` to prevent unnecessary re-renders.

---

## Cross-Cutting Best Practices

### 1. Stale Closure Prevention (10+ vulnerabilities)

The most pervasive issue. Affects: card execution, battle orchestration, inventory, resources, enemy AI.

```typescript
// BAD — reads stale closure value
const handleHeal = () => {
  setPlayerHp(playerHp + healAmount); // playerHp may be stale
};

// GOOD — reads latest value
const handleHeal = () => {
  setPlayerHp(prev => Math.min(prev + healAmount, maxHp));
};
```

**For complex multi-field updates — Accumulated Changes Pattern:**

```typescript
function executeCard(card) {
  const changes = { hp: 0, guard: 0, enemyHp: 0, buffs: new Map(currentBuffs) };

  // All calculations mutate local object, not React state
  changes.enemyHp -= calculateDamage(...);
  changes.hp += calculateHeal(...);
  changes.guard += calculateGuard(...);

  // Single commit
  setPlayerHp(prev => Math.min(prev + changes.hp, maxHp));
  setPlayerGuard(prev => prev + changes.guard);
  setEnemyHp(prev => prev + changes.enemyHp);
  setEnemyBuffs(changes.buffs);
}
```

**For refs wrapping callbacks:** Assign `.current` immediately after function definition, not in useEffect.

### 2. Single Source of Truth for State

```
RULE: One owner per piece of state. Readers observe; they never copy.

BAD:  ResourceContext owns gold → PlayerContext copies gold → drift
GOOD: ResourceContext owns gold → PlayerContext reads via useResources()
```

- Never maintain the same data in two contexts
- For multi-step operations (equip: remove + set slot + add displaced), batch into single state update

### 3. Data-Driven Design Over Hardcoding

```typescript
// BAD — hardcoded card ID check
if (card.id === 'sw_037' || card.id === 'sw_039' || card.id === 'sw_040') {
  convertEnergyToGuard();
}

// GOOD — card data declares capability
if (card.convertEnergyToGuard) {
  convertEnergyToGuard();
}

// BAD — hardcoded buff check
canAct = !map.has("stun")

// GOOD — data-driven
canAct = !DISABLING_DEBUFFS.some(d => map.has(d))
```

### 4. Consistency Rules

| Aspect | Rule |
|--------|------|
| Buff timing | Choose "healing before tick" OR "after tick" — apply uniformly to both phases |
| Stack effects | If `stackable: true`, the effect formula MUST include `* stacks` |
| Damage pipeline | All damage should flow through `applyDamageAllocation` |
| Save coverage | Every persistent field in PlayerData/ResourceState must appear in SaveData |
| Randomness | UI-visible predictions (enemy preview) must use the same seed as execution |

### 5. Immutable File Awareness

Two files MUST NOT be modified:

- `src/domain/cards/decks/deck.ts` (V-CARD-12: counter never resets)
- `src/domain/cards/decks/deckReducter.ts` (V-CARD-13: empty pile edge case)

Work around these by adding validation at call sites.

### 6. Execution-Time State Freshness

In async battle loops (multi-hit cards, multi-action enemy phases), React state setters are batched and don't reflect immediately. This causes:

- HP checks seeing pre-damage values (V-EXEC-01)
- Guard allocation using destroyed guard (V-EXEC-03)
- Debuff overwrites (V-EXEC-02)

**Pattern:** Track accumulated changes in local variables alongside state setters:

```typescript
let accumulatedDamage = 0;
for (const hit of hits) {
  const damage = calculateDamage(hit);
  accumulatedDamage += damage;
  setEnemyHp(prev => prev - damage);

  // Check against accumulated, not React state
  if (ctx.enemyHp - accumulatedDamage <= 0) break;
}
```

### 7. Phase Calculation Consistency

After calling `decreaseBuffDebuffDurationForPhase()`, **always** use the returned `newBuffs` for all subsequent phase calculations:

```typescript
// BAD — uses original buffs after duration decrease
const newBuffs = decreaseBuffDebuffDurationForPhase(enemyBuffs, 'enemy');
const healing = calculateStartPhaseHealing(enemyBuffs);  // ← wrong!
const canMove = canAct(enemyBuffs);                       // ← wrong!

// GOOD — consistently uses newBuffs
const newBuffs = decreaseBuffDebuffDurationForPhase(enemyBuffs, 'enemy');
const healing = calculateStartPhaseHealing(newBuffs);     // ← correct
const canMove = canAct(newBuffs);                         // ← correct
```

Player phase (`playerPhaseExecution.ts`) already follows this pattern correctly. Enemy phase must match.

---

## Safe Refactoring Order

Dependencies between fixes require a phased approach. Each phase can be done in parallel within itself but must complete before the next.

### Phase 1: State Foundation (No gameplay changes) ✅ COMPLETE (Session 1)

Fix the state management bugs first — they affect every other system.

1. ✅ **V-CS01** — Removed resource duplication from PlayerContext; all consumers use ResourceContext
2. ✅ **V-CS04** — Stabilized player ID via `useState` initializer
3. ✅ **V-CS11** — Converted all inventory operations to functional updaters
4. ✅ **V-CS02** — Moved `useGold` balance check inside functional updater
5. ✅ **V-CS03** — Fixed `useExplorationPoint` return value via mutable result object

**Verification:** Save → reload → verify gold, stones, inventory unchanged.

### Phase 2: Save System Integrity ✅ COMPLETE (Session 2)

Depends on Phase 1 (state must be correct before saving).

1. ✅ **V-CS06** — Added missing inventory/equipmentInventory to SaveData
2. ✅ **V-EC-06** — Added exploration resources to save
3. ✅ **V-CS07** — Implemented basic save migration (version check + field addition)
4. ✅ **V-INV-02** — Fixed equipItem removal from equipmentInventory

**Verification:** Full save/load cycle with items in all storage locations.

### Phase 3: Battle Core Fixes ✅ COMPLETE (Session 3–4)

Depends on Phase 1 (functional updaters required).

1. ✅ **V-CARD-04** — Heal uses functional updater for HP (Session 3)
2. ✅ **V-CARD-07** — Auto-bleed accumulates with other buff changes (Session 3)
3. ✅ **V-ORCH-01** — Fixed executeNextPhaseRef update gap (Session 3)
4. ✅ **V-DMG-04** — Added freeze/stagger to `canAct()` (Session 4)
5. ✅ **V-CARD-02** — Removed double guard application (Session 4)
6. ✅ **V-CARD-09** — Made useDeckManage class-aware (Session 4)

**Verification:** Play 5 battles as each class. Verify guard values, bleed application, freeze/stagger behavior.

### Phase 4: Class Mechanics & Consistency (Partial — 1/7 fixed)

Depends on Phase 3 (battle core must be stable).

1. ✅ **V-CLASS-03** — Wired resonance effects into battle execution (Session 4)
2. **V-DMG-06** — Bleed damage * stacks
3. **V-DMG-10** — Burn/poison DoT * stacks
4. **V-CLASS-13** — Fix dual-element chain logic
5. **V-CLASS-04** — Wire critBonus/penetration into damage pipeline (or remove dead code)
6. **V-DMG-01** — Consistent buff timing (healing vs duration decrease order)
7. **V-ENM-02** — Seeded randomness for enemy preview

**Verification:** Play Mage through 3 depths. Verify resonance effects trigger. Verify stacked DoTs deal proportional damage.

### Phase 5: Execution Pipeline Integrity (NEW)

Depends on Phase 3 (battle core must be stable). Addresses async execution bugs.

1. **V-EXEC-01** — Dead entity liveness checks with accumulated HP tracking
2. **V-EXEC-02** — Enemy multi-action debuff functional updaters
3. **V-EXEC-03** — Multi-hit guard/AP local tracking
4. **V-EXEC-04** — Enemy turnCount increment
5. **V-PHASE-01** — Enemy healing uses post-decrease buffs
6. **V-PHASE-02** — Enemy canAct uses post-decrease buffs
7. **V-CHAIN-01** — Mage resonance ordering (onCardPlayed before executeCard)

**Verification:** Multi-hit card kills enemy mid-combo → remaining hits don't execute. Enemy multi-action applies all debuffs. Mage resonance applies on current card, not next.

### Phase 6: UI Robustness (NEW)

Independent of battle phases. Addresses UI-layer bugs.

1. **V-UI-01** — Victory screen double-click protection
2. **V-UI-02** — Guild image path fix
3. **V-UI-03** — BattleScreen setTimeout cleanup on unmount
4. **V-UI-05** — Storage stale selectedItem safety

**Verification:** Rapid-click continue on victory → only one reward. Guild images load. Navigate away from battle mid-animation → no console errors.

### Phase 7: Quality & Cleanup (Independent — any order)

Extends previous Phase 5, incorporating new items.

- Remove dead code (V-CARD-05/10, V-DMG-09, V-ORCH-06/07, V-CODE-01, V-CODE-02)
- Consolidate duplicate constants (V-CLASS-10/11)
- Fix naming typos (V-CARD-15, V-PLR-07, V-DNG-06)
- Remove test data from production (V-CS08, V-INV-05)
- Replace hardcoded patterns with data-driven approach (V-CARD-03, V-DMG-07)
- File reorganization (V-DNG-04: move DungeonRunContext to `src/contexts/`)
- Extract PlayerContext subsystems (V-CS05)
- Memoize context provider values (V-PERF-01)
- Fix `cardSetters` memo dependency (V-PERF-02)
- Clean up notification timeouts (V-PERF-03)
- Fix initial card unlocks per class (V-CODE-03)
- Remove unused `onDepthChange` prop (V-UI-06)
- Implement `nextCardCostReduction` or remove from cards (V-CARD-NEW-04)
- Add cycle detection to cardDerivation ancestor trace (V-CARD-NEW-05)
- Reconcile MASTERY_BONUSES constant (V-CARD-NEW-01)
- Wire `penetration` into damage pipeline or remove (V-CARD-NEW-02)
- Validate `requiresSummon` in canPlayCard (V-CARD-NEW-03)
- Fix dead code in damageManage.ts (V-DMG-MANAGE-01)
- Fix memoization of BuyTab functions (V-UI-04)

---

## Testing Strategy

No test framework is configured. All verification is manual in-browser.

### Critical Path Tests (Phases 1–2)

| Test | Steps | Expected |
|------|-------|----------|
| Save integrity | Buy item → equip → save → reload | All items preserved in correct locations |
| Resource consistency | Buy item rapidly 3x → check gold | Gold decremented exactly 3x item price |
| Inventory rapid ops | Open 6-item pack quickly | All 6 items appear in inventory |
| Player ID stability | Navigate between screens 5x | Same player ID throughout |

### Battle Tests (Phases 3–5)

| Test | Steps | Expected |
|------|-------|----------|
| Stun/Freeze/Stagger | Apply freeze to enemy → their turn | Enemy skips turn |
| Guard single source | Play defense card → check guard value | Guard = ONE of shieldGain or guardAmount, not both |
| Heal after reflect | Play card that reflects + heals | HP reflects both damage and heal correctly |
| Bleed stacks | Apply bleed 3x → enemy turn | Bleed damage = `floor(maxHp * rate) * 3` |
| Mage resonance | Chain 3 fire cards → check enemy | Burn debuff applied to enemy |
| Class deck | Start battle as Mage | Deck contains Mage cards, not Swordsman |
| Multi-hit kill | 3-hit card kills on hit 1 | Hits 2-3 do not execute |
| Enemy multi-debuff | Enemy uses 2-action turn with debuffs | Both debuffs applied to player |
| Enemy turn patterns | Reach turn 3+ vs pattern enemy | Turn-gated abilities activate |

### UI Tests (Phase 6)

| Test | Steps | Expected |
|------|-------|----------|
| Victory double-click | Rapidly click continue 5x | Only one reward granted, single screen transition |
| Guild images | Open Guild screen | Character images load correctly |
| Battle unmount | Navigate away mid-battle animation | No console errors |

### Regression Checklist

After any fix, verify:

- [ ] `npm run build` succeeds
- [ ] Character select → camp → dungeon → battle flow works
- [ ] Save/load preserves all state
- [ ] No console errors during normal gameplay
- [ ] Each character class can enter and complete a battle

---

## Vulnerability Count Summary

| Tier | Total | Fixed | Remaining | Category |
|------|-------|-------|-----------|----------|
| 0 (Critical) | 7 | 5 (V-CS01, V-CS04, V-CS11, V-CS06, V-INV-02) | 2 | Data loss / corruption |
| 1 (High) | 13 | 8 (V-CS02, V-DMG-04, V-CARD-02, V-CARD-04, V-CARD-07, V-CARD-09, V-CLASS-03, V-ORCH-01) | 5 | Gameplay-breaking |
| 2 (Medium) | 40 | 6 (V-CS03, V-CS07, V-EC-06, V-ORCH-02, V-ORCH-03, V-ORCH-04) | 34 | Logic errors / edge cases |
| 3 (Low) | 46 | 0 | 46 | Quality / extensibility / cleanup |
| **Total** | **106** | **19** | **87** | |

**Cross-cutting patterns:** Stale closures (10+), execution-time state freshness (5+), duplicate state/code (8+), phase calculation inconsistency (3+), stub systems (7), hardcoded logic (5+), inconsistent buff handling (5+), naming typos (3), UI safety (4+).
